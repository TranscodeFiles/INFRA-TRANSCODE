version: "2"
services:

  #######################################################
  ####################### CORE ##########################
  #######################################################
  rabbit1:
    image: bijukunjummen/rabbitmq-server
    hostname: rabbit1
    ports:
      - "5672:5672"
      - "15672:15672"

  rabbit2:
    image: bijukunjummen/rabbitmq-server
    hostname: rabbit2
    links:
      - rabbit1
    environment:
      - CLUSTERED=true
      - CLUSTER_WITH=rabbit1
      - RAM_NODE=true
    ports:
      - "5673:5672"
      - "15673:15672"

  rabbit3:
    image: bijukunjummen/rabbitmq-server
    hostname: rabbit3
    links:
      - rabbit1
      - rabbit2
    environment:
      - CLUSTERED=true
      - CLUSTER_WITH=rabbit1
    ports:
      - "5674:5672"

  api-core:
    build: ./core/core-api
    links:
      - rabbit1:rabbit
    volumes: 
      - ./core/core-api/app:/deploy/app
#    ports:
 #     - "5001:5001"

  lb-core:
    image: dockercloud/haproxy
    links:
      - api-core
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 5000:80

  worker:
    build: ./core/core-api
    restart: allways
    links:
      - rabbit1:rabbit
    volumes: 
      - ./core/core-api/app:/deploy/app
    entrypoint:
      - /docker-entrypoint.sh
      - worker

  #######################################################
  ####################### WEB ##########################
  #######################################################
  web:
    image: vincentchalamon/symfony 
    volumes:
      - ./web/app:/var/www
    tty: true
    links:
      - mariadb
      
  mariadb:
    image: mariadb 
    restart: allways
    volumes:
      - ./web/mariadb:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: app_transcode
      MYSQL_USER: root
      MYSQL_PASSWORD: root
      TERM: dumb

  lb-web:
    image: dockercloud/haproxy
    links:
      - web
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 8080:80
      - 1936:1936

